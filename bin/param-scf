#!/bin/bash

set -e

color='\033[1\0;31m'
endcolor='\033[0m'

function usage {
    echo 1>&2 -e $color
    echo 1>&2 -e "usage: $(basename $0) [quality]" 2>&1
    echo 1>&2 -e $endcolor
    echo 1>&2 "$(basename $0)  dm-fast"
    echo 1>&2 "$(basename $0)  dm-normal"
    echo 1>&2 "$(basename $0)  dm-slow"
    echo 1>&2 "$(basename $0)  dm-veryslow"
    echo 1>&2 "$(basename $0)  edft"
    echo 1>&2 
    exit 1
}

# check before proceeding

if [ $# -lt 1 ]; then
    usage
fi

case $1 in
    dm-fast | dm-normal | dm-slow | dm-veryslow | edft)
        quality=$1
        ;;
    *)
        echo "invalid option: $1"
        usage
        ;;
esac

# main

for seed in $(ls *.param | awk 'BEGIN {FS=".param"} {print $1}')
do
    echo "$seed.param"

    keys="metals_method mix_charge_amp mix_spin_amp"

    for key in $keys
    do
        nkey=$(sed -n "/^$key/p" $seed.param | wc -l)
        if [[ $nkey -ne 1 ]]
        then
            sed -i "/^$key/d" $seed.param
            printf "%-25s : \n" "$key" >> $seed.param
        fi
    done


    if [[ $quality == "dm-fast" ]] # MS express quality
    then
        sed -i 's/^max_scf_cycles [[:print:]]*/max_scf_cycles            : 200/' $seed.param
        sed -i 's/^metals_method [[:print:]]*/metals_method             : dm/' $seed.param
        sed -i 's/^mix_charge_amp [[:print:]]*/mix_charge_amp            : 0.5/' $seed.param
        sed -i 's/^mix_spin_amp [[:print:]]*/mix_spin_amp              : 2.0/' $seed.param

    elif [[ $quality == "dm-normal" ]] # MS express quality
    then
        sed -i 's/^max_scf_cycles [[:print:]]*/max_scf_cycles            : 200/' $seed.param
        sed -i 's/^metals_method [[:print:]]*/metals_method             : dm/' $seed.param
        sed -i 's/^mix_charge_amp [[:print:]]*/mix_charge_amp            : 0.2/' $seed.param
        sed -i 's/^mix_spin_amp [[:print:]]*/mix_spin_amp              : 1.0/' $seed.param

    elif [[ $quality == "dm-slow" ]] # MS coarse quality
    then
        sed -i 's/^max_scf_cycles [[:print:]]*/max_scf_cycles            : 200/' $seed.param
        sed -i 's/^metals_method [[:print:]]*/metals_method             : dm/' $seed.param
        sed -i 's/^mix_charge_amp [[:print:]]*/mix_charge_amp            : 0.1/' $seed.param
        sed -i 's/^mix_spin_amp [[:print:]]*/mix_spin_amp              : 0.5/' $seed.param

    elif [[ $quality == "dm-veryslow" ]] # CASTEP default
    then
        sed -i 's/^max_scf_cycles [[:print:]]*/max_scf_cycles            : 200/' $seed.param
        sed -i 's/^metals_method [[:print:]]*/metals_method             : dm/' $seed.param
        sed -i 's/^mix_charge_amp [[:print:]]*/mix_charge_amp            : 0.05/' $seed.param
        sed -i 's/^mix_spin_amp [[:print:]]*/mix_spin_amp              : 0.2/' $seed.param

    elif [[ $quality == "edft" ]] # MS medium quality
    then
        sed -i 's/^metals_method [[:print:]]*/metals_method             : edft/' $seed.param
    fi

done

exit 0
