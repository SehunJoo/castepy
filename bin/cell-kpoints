#!/bin/bash

set -e

color='\033[1\0;31m'
endcolor='\033[0m'

function usage {
    echo 1>&2 -e $color
    echo 1>&2 -e "usage: $(basename $0) [on/off]" 2>&1
    echo 1>&2 -e $endcolor
    echo 1>&2 "$(basename $0)  0.03"
    echo 1>&2 "$(basename $0)  off"
    echo 1>&2
    exit 1
}

# check before proceeding

if [ $# -ne 1 ]; then
    usage
fi

kpoints=$1

#case $1 in
#    on | off)
#        kpoints=$1
#        ;;
#    *)
#        kpoints=$1
#        #echo "invalid option: $1"
#        #usage
#        ;;
#esac

# main

for seed in $(ls *.cell | awk 'BEGIN {FS=".cell"} {print $1}')
do
    echo "$seed.cell"

    [[ $(sed -n '/^KPOINTS_MP_SPACING /p'   $seed.cell | wc -l) -gt 1 ]] && echo "Error: kpoints_mp_spacing keyword" && exit 1

    [[ $(sed -n '/^KPOINTS_MP_SPACING /p'   $seed.cell | wc -l) -lt 1 ]] && echo "KPOINTS_MP_SPACING "      >> $seed.cell

    if [[ $kpoints == "off" ]]
    then
        sed -i '/^KPOINTS_MP_SPACING[[:print:]]*/d' $seed.cell
        sed -i '/^#KPOINTS_MP_SPACING[[:print:]]*/d' $seed.cell
    else
            sed -i "s/KPOINTS_MP_SPACING [[:print:]]*/KPOINTS_MP_SPACING $kpoints/" $seed.cell
    fi

done

exit 0
