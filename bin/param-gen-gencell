#!/bin/bash

set -e

color='\033[1\0;31m'
endcolor='\033[0m'

## test usage is correct

function usage {
    echo 1>&2
    echo 1>&2 "Usage: $(basename $0) <seed>"
    echo 1>&2
    echo 1>&2 "Example:"
    echo 1>&2 "$(basename $0) LiCoO2"
    echo 1>&2 "$(basename $0) auto"
    echo 1>&2
    exit 1
}

[[ $# -ne 1 ]] && usage

## set the input variables 

seed=$1

if [[ $seed == "auto" ]]; then
    if ! ls *.param &>/dev/null; then
        echo 1>&2 "*.param files not found"
        exit 1
    else
        nparam=$(ls *.param | wc -l)
        [[ $nparam -gt 1 ]] && echo 1>&2 "too many *.param files detected ..." && ls *.param && exit 1
        [[ $nparam -eq 1 ]] && seed=`ls *.param | awk 'BEGIN {FS=".param"} {print $1}'`
    fi
fi

## checks before proceeding

rm -f $seed-gencell.param
rm -f $seed-gencell.param.*

## main

echo -e $color
echo -e "Generating $seed-gencell.param file ..."
echo -e $endcolor

cat<<EOF>$seed-gencell.param
task                 : geometryoptimization
xc_functional        : PBE 
spin_polarized       : false 
fix_occupancy        : false 
metals_method        : dm 
mixing_scheme        : pulay 
max_scf_cycles       : 1000 
cut_off_energy       : 340 eV
opt_strategy         : speed 
page_wvfns           : 0 
num_dump_cycles      : 0 
backup_interval      : 0 
geom_method          : LBFGS 
geom_max_iter        : 20 
mix_history_length   : 20 
finite_basis_corr    : 0
fixed_npw            : true
write_cell_structure : true
write_checkpoint     : none
write_bib            : false
write_otfg           : false
write_cst_esp        : false
write_bands          : false
write_geom           : false
bs_write_eigenvalues : false
calculate_stress     : true
EOF

#cat $seed-gencell.param

exit 0
