#!/bin/bash

set -e

color='\033[1\0;31m'
endcolor='\033[0m'

## test usage is correct
function usage {
    echo 1>&2
    echo 1>&2 "Usage: $(basename $0) <seed>"
    echo 1>&2
    echo 1>&2 "Example:"
    echo 1>&2 "$(basename $0) LiCoO2"
    echo 1>&2 "$(basename $0) auto"
    echo 1>&2
    exit 1
}

[[ $# -ne 1 ]] && usage

## set the input variables 

seed=$1

if [[ $seed == "auto" ]]; then
    if ! ls *.param &>/dev/null; then
        echo 1>&2 "*.param files not found"
        exit 1
    else
        nparam=$(ls *.param | wc -l)
        [[ $nparam -gt 1 ]] && echo 1>&2 "too many *.param files detected ..." && ls *.param && exit 1
        [[ $nparam -eq 1 ]] && seed=`ls *.param | awk 'BEGIN {FS=".param"} {print $1}'`
    fi
fi


## checks before proceeding

rm -f $seed.param.temp

dos2unix $seed.param 1> /dev/null 2>&1

# backup

md5=`md5sum $seed.param | cut -c 1-8`
cp $seed.param $seed.param.$md5

## main

echo -e $color
echo "Cleaning $seed.param file ..."
echo -e $endcoclor

echo -e $color
echo -e "original $seed.param"
echo -e $endcolor

cat $seed.param

## loop over (keyword and value) pairs in seed.param

for key in $(awk 'BEGIN {FS=":"} {print $1}' $seed.param | awk '{print tolower($1)}')
do

    line=$(sed -n "/^$key /Ip" $seed.param)

    # check if this line is the comment line
    if [[ $(echo "$line" | grep ":" | wc -l) -lt 1 ]]; then

        echo "$line" >> $seed.param.temp

    else
        # check if this line includes ##ref
        if [[ $(echo "$line" | grep "##ref" | wc -l) -ge 1 ]]; then
            val=$(echo "$line" | awk 'BEGIN {FS=":"} {print tolower($2)}' | sed -e 's/^ *//g' -e 's/ *$//g')
        else
            val=$(echo "$line" | awk 'BEGIN {FS=":"} {print $2}' | awk '{print tolower($1)}')
        fi

        key=$(echo $key | sed 's/#//g')

        printf "%-25s : %s\n" "$key" "$val" >> $seed.param.temp
    fi
done

echo -e $color
echo -e "after cleaning"
echo -e $endcolor

mv $seed.param.temp $seed.param
cat $seed.param

# for debugging
#cat $seed.param.temp

exit 0
