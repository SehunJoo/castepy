#!/bin/bash

set -e

color='\033[1\0;31m'
endcolor='\033[0m'

function usage {
    echo 1>&2 -e $color
    echo 1>&2 -e "usage: $(basename $0) [on/off]"
    echo 1>&2 -e $endcolor
    echo 1>&2 "$(basename $0)  on"
    echo 1>&2 "$(basename $0)  off"
    echo 1>&2
    exit 1
}

# check before proceeding

if [ $# -lt 1 ]; then
    usage
fi

case $1 in
    on | off)
        sym=$1
        ;;
    *)
        echo "invalid option: $1"
        usage
        ;;
esac

# main

for seed in $(ls *.cell | awk 'BEGIN {FS=".cell"} {print $1}')
do
    echo "$seed.cell"

    if [[ $sym == "on" ]]
    then
        nlines=$(sed -n '/^%BLOCK SYMMETRY_OPS/,/^%ENDBLOCK SYMMETRY_OPS/p' $seed.cell | wc -l)
        if [[ $nlines -ne 0 ]]
        then
            echo "Warning: SYMMETRY_OPS block detected ..."
            exit 1
        fi

        echo >> $seed.cell

        nlines=$(sed -n '/^SYMMETRY_GENERATE/p' $seed.cell | wc -l)
        if [[ $nlines -eq 0 ]]
        then
            echo "SYMMETRY_GENERATE" >> $seed.cell
        fi

        nlines=$(sed -n '/^SNAP_TO_SYMMETRY/p' $seed.cell | wc -l)
        if [[ $nlines -eq 0 ]]
        then
            echo "SNAP_TO_SYMMETRY" >> $seed.cell
        fi

    elif [[ $sym == "off" ]]
    then
        sed -i '/^SYMMETRY_GENERATE[[:print:]]*/d' $seed.cell
        sed -i '/^SNAP_TO_SYMMETRY[[:print:]]*/d' $seed.cell
        sed -i '/^%BLOCK SYMMETRY_OPS/,/^%ENDBLOCK SYMMETRY_OPS/d' $seed.cell
        sed -i '/^#SYMMETRY_GENERATE[[:print:]]*/d' $seed.cell
        sed -i '/^#SNAP_TO_SYMMETRY[[:print:]]*/d' $seed.cell
        sed -i '/^#%BLOCK SYMMETRY_OPS/,/^#%ENDBLOCK SYMMETRY_OPS/d' $seed.cell
    fi
done

exit 0
